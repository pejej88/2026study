<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>블랙야크 100대명산 발자국</title>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        h1 { text-align: center; margin-bottom: 10px; }
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .controls button {
            padding: 8px 14px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
        }
        .controls button.active { background: #fee500; border-color: #fee500; }
        .controls button:hover { background: #f5f5f5; }
        .controls button.active:hover { background: #e6d000; }
        #map { width: 100%; height: 800px; }
        .sidebar {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 260px;
            max-height: 80vh;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .sidebar h3 { margin: 0 0 8px 0; font-size: 14px; }
        .sidebar ul { margin: 0; padding-left: 18px; font-size: 13px; }
        .sidebar li { margin: 4px 0; }
        .status { font-size: 12px; color: #666; margin-top: 8px; }
    </style>
</head>
<body>
<h1>블랙야크 100대명산 발자국</h1>
<div class="controls">
    <span>지도 타입:</span>
    <button type="button" id="btnRoadmap" class="active">도로</button>
    <button type="button" id="btnSkyview">위성</button>
    <button type="button" id="btnHybrid">위성+도로</button>
</div>
<div id="map"></div>

<div class="sidebar" id="sidebar">
    <h3>내 방문 목록 (<span id="footprintCount">0</span>/100)</h3>
    <ul id="footprintList"></ul>
    <p class="status" id="statusText">지도에서 산을 클릭해 발자국을 찍어보세요.</p>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=d1e72c968b6e8b460896927f9ef87753"></script>
<script>
// CSV 기반 100대 명산 데이터 (API 없이도 지도 마커 표시)
var EMBEDDED_MOUNTAINS = [
    {id:1,name:"가리산(홍천)",address:"강원 홍천군 두촌면",latitude:37.871378,longitude:127.956469},
    {id:2,name:"가리왕산",address:"강원 정선군 정선읍 회동리",latitude:37.461642,longitude:128.563042},
    {id:3,name:"가야산(경상)",address:"경남 합천군 가야면",latitude:35.823577,longitude:128.120582},
    {id:4,name:"가야산(충남)",address:"충남 예산군",latitude:36.706541,longitude:126.608205},
    {id:5,name:"가지산",address:"울산 울주군 상북면",latitude:35.619684,longitude:129.002975},
    {id:6,name:"감악산(원주)",address:"강원 원주시 신림면 용암리",latitude:37.229681,longitude:128.141768},
    {id:7,name:"감악산(파주)",address:"경기 파주시 적성면 설마리",latitude:37.941077,longitude:126.969883},
    {id:8,name:"계룡산",address:"충남 공주시",latitude:36.352011,longitude:127.200346},
    {id:9,name:"계방산",address:"강원 평창군 용평면 노동리",latitude:37.728257,longitude:128.465416},
    {id:10,name:"관악산",address:"서울 관악구 대학동",latitude:37.444935,longitude:126.964317},
    {id:11,name:"광덕산",address:"충남 천안시 동남구 광덕면",latitude:36.687811,longitude:127.027875},
    {id:12,name:"구병산(보은)",address:"충북 보은군 마로면",latitude:36.469584,longitude:127.861734},
    {id:13,name:"구봉산(진안)",address:"전북 진안군 주천면 운봉리",latitude:35.92316,longitude:127.416524},
    {id:14,name:"금수산",address:"충북 제천시 수산면 상천리",latitude:36.984983,longitude:128.256754},
    {id:15,name:"금오산(구미)",address:"경북 구미시 남통동",latitude:36.091786,longitude:128.300225},
    {id:16,name:"금정산",address:"경남 양산시 동면 가산리",latitude:35.280139,longitude:129.050583},
    {id:17,name:"남산(경주)",address:"경북 경주시",latitude:35.788846,longitude:129.222876},
    {id:18,name:"내변산(부안)",address:"전북 부안군 변산면",latitude:35.623238,longitude:126.582396},
    {id:19,name:"내연산",address:"경북 영덕군 남정면",latitude:36.278644,longitude:129.289861},
    {id:20,name:"내장산",address:"전북 정읍시 내장동",latitude:35.47832,longitude:126.889075},
    {id:21,name:"달마산",address:"전남 해남군 송지면 가차리",latitude:34.382578,longitude:126.585164},
    {id:22,name:"대둔산",address:"충남 논산시",latitude:36.124589,longitude:127.320472},
    {id:23,name:"대야산",address:"충북 괴산군 청천면",latitude:36.669121,longitude:127.929446},
    {id:24,name:"덕룡산",address:"전남",latitude:34.538568,longitude:126.699227},
    {id:25,name:"덕유산",address:"전북 무주군 설천면 삼공리",latitude:35.859883,longitude:127.746321},
    {id:26,name:"덕항산",address:"강원 삼척시 하장면",latitude:37.309148,longitude:129.012521},
    {id:27,name:"도락산",address:"충북 단양군 단성면 가산리",latitude:36.856303,longitude:128.311325},
    {id:28,name:"도봉산",address:"서울 도봉구 도봉동",latitude:37.698506,longitude:127.015026},
    {id:29,name:"동악산(곡성)",address:"전남 곡성군 곡성읍",latitude:35.282,longitude:127.251925},
    {id:30,name:"두륜산",address:"전남 해남군 삼산면",latitude:34.471914,longitude:126.637561},
    {id:31,name:"두타산",address:"강원 삼척시 하장면",latitude:37.426639,longitude:129.004428},
    {id:32,name:"마니산(강화도)",address:"인천 강화군 화도면",latitude:37.615564,longitude:126.430025},
    {id:33,name:"마이산(진안)",address:"전북",latitude:35.763584,longitude:127.396739},
    {id:34,name:"명지산",address:"경기 가평군 북면",latitude:37.941532,longitude:127.432207},
    {id:35,name:"모악산",address:"전북 완주군 구이면",latitude:35.728588,longitude:127.08524},
    {id:36,name:"무등산",address:"광주 동구 지산동",latitude:35.120971,longitude:127.002791},
    {id:37,name:"민주지산",address:"충북 영동군 용화면",latitude:36.039956,longitude:127.849098},
    {id:38,name:"방장산",address:"전남 장성군 북이면",latitude:35.455635,longitude:126.754379},
    {id:39,name:"방태산",address:"강원 인제군 기린면",latitude:37.888115,longitude:128.390009},
    {id:40,name:"백덕산",address:"강원 영월군 수주면 법흥리",latitude:37.396431,longitude:128.2935},
    {id:41,name:"백암산",address:"전남 장성군 북하면",latitude:35.461286,longitude:126.868469},
    {id:42,name:"백운산(광양)",address:"전남 광양시 옥룡면",latitude:35.106372,longitude:127.621344},
    {id:43,name:"백운산(동강)",address:"강원 정선군 신동읍",latitude:37.279994,longitude:128.596094},
    {id:44,name:"북한산",address:"서울 성북구 정릉동",latitude:37.658698,longitude:126.978272},
    {id:45,name:"불갑산(영광)",address:"전남 영광군 불갑면",latitude:35.19074,longitude:126.565029},
    {id:46,name:"비슬산",address:"대구 달성군 유가면",latitude:35.715453,longitude:128.523791},
    {id:47,name:"삼악산",address:"강원 춘천시 서면",latitude:37.839782,longitude:127.660429},
    {id:48,name:"선운산",address:"전북 고창군 아산면",latitude:35.498586,longitude:126.569022},
    {id:49,name:"설악산",address:"강원 양양군 서면 오색리",latitude:38.119062,longitude:128.465286},
    {id:50,name:"소백산",address:"경북 영주시 풍기읍",latitude:36.957437,longitude:128.484869},
    {id:51,name:"소요산",address:"경기 동두천시 소요동",latitude:37.938513,longitude:127.08791},
    {id:52,name:"속리산",address:"충북 보은군 속리산면 상판리",latitude:36.543193,longitude:127.870804},
    {id:53,name:"수락산",address:"서울 노원구 상계동",latitude:37.699173,longitude:127.081237},
    {id:54,name:"신불산",address:"울산 울주군 상북면",latitude:35.539361,longitude:129.054111},
    {id:55,name:"연인산",address:"경기 가평군 가평읍 승안리",latitude:37.898784,longitude:127.414388},
    {id:56,name:"오대산 노인봉",address:"강원 강릉시 연곡면",latitude:37.78251,longitude:128.639083},
    {id:57,name:"오대산 비로봉",address:"강원 평창군 진부면 동산리",latitude:37.794591,longitude:128.543609},
    {id:58,name:"오봉산(춘천)",address:"강원 춘천시 북산면",latitude:38.000049,longitude:127.807134},
    {id:59,name:"오서산(보령)",address:"충남 홍성군 광천읍",latitude:36.458367,longitude:126.659331},
    {id:60,name:"용문산(양평)",address:"경기 양평군 용문면 신점리",latitude:37.56215,longitude:127.548597},
    {id:61,name:"용봉산(홍성)",address:"충남 홍성군 홍북면",latitude:36.643662,longitude:126.64925},
    {id:62,name:"용화산",address:"강원 춘천시 사북면 고탄리",latitude:38.038181,longitude:127.747992},
    {id:63,name:"운악산",address:"경기",latitude:37.878689,longitude:127.322899},
    {id:64,name:"운장산",address:"전북 진안군 주천면",latitude:35.911331,longitude:127.357646},
    {id:65,name:"월악산",address:"충북 제천시 한수면",latitude:36.88608,longitude:128.105847},
    {id:66,name:"월출산",address:"전남 영암군 영암읍",latitude:34.766684,longitude:126.704081},
    {id:67,name:"유명산",address:"경기 가평군 설악면",latitude:37.575283,longitude:127.486572},
    {id:68,name:"응봉산(울진)",address:"강원 삼척시 가곡면",latitude:37.076589,longitude:129.230517},
    {id:69,name:"장안산",address:"전북 장수군 장수읍",latitude:35.629213,longitude:127.595046},
    {id:70,name:"재약산",address:"경남 밀양시 단장면",latitude:35.545386,longitude:128.980541},
    {id:71,name:"조계산",address:"전남 순천시 송광면",latitude:35.001299,longitude:127.31359},
    {id:72,name:"조령산",address:"경북 문경시 문경읍",latitude:36.771456,longitude:128.044244},
    {id:73,name:"주왕산",address:"경북 청송군 부동면",latitude:36.38935,longitude:129.162394},
    {id:74,name:"주흘산",address:"경북",latitude:36.778068,longitude:128.106006},
    {id:75,name:"지리산",address:"경남 함양군",latitude:35.33691,longitude:127.730623},
    {id:76,name:"지리산 바래봉",address:"전북 남원시 운봉읍",latitude:35.421814,longitude:127.57632},
    {id:77,name:"지리산 반야봉",address:"전북 남원시",latitude:35.316596,longitude:127.569399},
    {id:78,name:"천관산",address:"전남 장흥군 관산읍",latitude:34.531669,longitude:126.919697},
    {id:79,name:"천마산",address:"경기 남양주시 화도읍",latitude:37.680237,longitude:127.273314},
    {id:80,name:"천태산",address:"충북 영동군 양산면",latitude:36.159169,longitude:127.6001},
    {id:81,name:"청계산",address:"서울 서초구 신원동",latitude:37.427998,longitude:127.043578},
    {id:82,name:"청량산",address:"경북 봉화군 명호면",latitude:36.794336,longitude:128.908553},
    {id:83,name:"청화산",address:"충북 괴산군 청천면",latitude:36.603707,longitude:127.920357},
    {id:84,name:"축령산(장성)",address:"전남 장성군 서삼면",latitude:35.370958,longitude:126.726042},
    {id:85,name:"치악산",address:"강원 원주시 소초면 학곡리",latitude:37.364995,longitude:128.055601},
    {id:86,name:"칠갑산(청양)",address:"충남 청양군 대치면",latitude:36.413035,longitude:126.884918},
    {id:87,name:"칠보산(괴산)",address:"충북 괴산군 칠성면 태성리",latitude:36.740037,longitude:127.927891},
    {id:88,name:"태백산",address:"강원 태백시",latitude:37.096379,longitude:128.916636},
    {id:89,name:"태화산",address:"강원 영월군 영월읍",latitude:37.117592,longitude:128.485383},
    {id:90,name:"팔공산",address:"경북 칠곡군 동명면 득명리",latitude:36.016377,longitude:128.694556},
    {id:91,name:"팔봉산(홍천)",address:"강원 홍천군 서면",latitude:37.695984,longitude:127.697044},
    {id:92,name:"팔영산",address:"전남 고흥군 점암면",latitude:34.617153,longitude:127.436453},
    {id:93,name:"한라산",address:"제주",latitude:33.361009,longitude:126.535659},
    {id:94,name:"함백산",address:"강원 정선군 고한읍",latitude:37.161181,longitude:128.917603},
    {id:95,name:"화악산(가평)",address:"경기 가평군 북면",latitude:37.989347,longitude:127.498155},
    {id:96,name:"화왕산(창녕)",address:"경남 창녕군 창녕읍",latitude:35.547123,longitude:128.531684},
    {id:97,name:"황매산(산청)",address:"경남 합천군 가회면",latitude:35.494066,longitude:127.974609},
    {id:98,name:"황석산(함양)",address:"경남 함양군 서하면 봉전리",latitude:35.655174,longitude:127.755471},
    {id:99,name:"황악산(김천)",address:"경북 김천시 대항면",latitude:36.118076,longitude:127.966822}
];

(function() {
    var API = '/api';
    var NEAR_RADIUS_M = 500;

    function getUserKey() {
        var key = 'user_key';
        var id = localStorage.getItem(key);
        if (!id) {
            id = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            localStorage.setItem(key, id);
        }
        return id;
    }

    function haversineMeters(lat1, lon1, lat2, lon2) {
        var R = 6371000;
        var dLat = (lat2 - lat1) * Math.PI / 180;
        var dLon = (lon2 - lon1) * Math.PI / 180;
        var a = Math.sin(dLat/2)*Math.sin(dLat/2) +
                Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function setStatus(msg) {
        var el = document.getElementById('statusText');
        if (el) el.textContent = msg;
    }

    function fetchMountains() {
        return fetch(API + '/mountains').then(function(r) {
            if (!r.ok) throw new Error('산 목록을 불러올 수 없습니다.');
            return r.json();
        });
    }

    function fetchMyFootprints() {
        return fetch(API + '/footprints?user_key=' + encodeURIComponent(getUserKey())).then(function(r) {
            if (!r.ok) return [];
            return r.json();
        });
    }

    function postFootprint(mountainId, latitude, longitude) {
        return fetch(API + '/footprints', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mountain_id: mountainId,
                latitude: latitude,
                longitude: longitude,
                user_key: getUserKey()
            })
        }).then(function(r) {
            if (!r.ok) throw new Error('저장에 실패했습니다.');
            return r.json();
        });
    }

    kakao.maps.load(function() {
        var mapContainer = document.getElementById('map');
        var mapOption = {
            center: new kakao.maps.LatLng(36.5, 127.5),
            level: 7
        };
        var map = new kakao.maps.Map(mapContainer, mapOption);

        var imageSrc = 'pngwing.png';
        var imageSize = new kakao.maps.Size(44, 44);
        var imageOption = { offset: new kakao.maps.Point(22, 44) }; // 깃발 끝(하단 중앙)이 좌표에 오도록
        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);

        var infowindow = new kakao.maps.InfoWindow({ removable: true });

        var mountains = [];
        var visitedIds = {};
        var markers = [];

        function setMapType(typeId) {
            map.setMapTypeId(typeId);
            document.querySelectorAll('.controls button').forEach(function(btn) { btn.classList.remove('active'); });
            if (typeId === kakao.maps.MapTypeId.ROADMAP) document.getElementById('btnRoadmap').classList.add('active');
            else if (typeId === kakao.maps.MapTypeId.SKYVIEW) document.getElementById('btnSkyview').classList.add('active');
            else document.getElementById('btnHybrid').classList.add('active');
        }
        document.getElementById('btnRoadmap').onclick = function() { setMapType(kakao.maps.MapTypeId.ROADMAP); };
        document.getElementById('btnSkyview').onclick = function() { setMapType(kakao.maps.MapTypeId.SKYVIEW); };
        document.getElementById('btnHybrid').onclick = function() { setMapType(kakao.maps.MapTypeId.HYBRID); };

        function buildInfowindowContent(m, isVisited) {
            var html = '<div style="padding:10px;min-width:180px;">' +
                '<b>' + escapeHtml(m.name) + '</b><br>' + escapeHtml(m.address || '') + '<br>';
            if (isVisited) {
                html += '<span style="color:green;font-size:12px;">✓ 방문 완료</span>';
            } else {
                html += '<button type="button" id="btnStamp" style="margin-top:8px;padding:6px 12px;cursor:pointer;">발자국 찍기</button>';
            }
            html += '</div>';
            return html;
        }
        function escapeHtml(s) {
            if (!s) return '';
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function refreshFootprintList() {
            var listEl = document.getElementById('footprintList');
            var countEl = document.getElementById('footprintCount');
            if (!listEl) return;
            var names = mountains.filter(function(m) { return visitedIds[m.id]; }).map(function(m) { return m.name; });
            countEl.textContent = names.length;
            listEl.innerHTML = names.slice(0, 30).map(function(n) { return '<li>' + escapeHtml(n) + '</li>'; }).join('');
            if (names.length > 30) listEl.innerHTML += '<li>... 외 ' + (names.length - 30) + '곳</li>';
        }

        function getLat(m) { return m.latitude != null ? m.latitude : m.lat; }
        function getLon(m) { return m.longitude != null ? m.longitude : m.lon; }

        function addMarkers() {
            var bounds = new kakao.maps.LatLngBounds();
            for (var i = 0; i < mountains.length; i++) {
                var m = mountains[i];
                var lat = getLat(m), lon = getLon(m);
                if (lat == null || lon == null || isNaN(lat) || isNaN(lon)) continue;
                var latlng = new kakao.maps.LatLng(lat, lon);
                bounds.extend(latlng);
                var marker = new kakao.maps.Marker({
                    map: map,
                    position: latlng,
                    title: m.name,
                    image: markerImage
                });
                markers.push({ marker: marker, mountain: m });
                (function(mountain) {
                    kakao.maps.event.addListener(marker, 'click', function() {
                        var isVisited = !!visitedIds[mountain.id];
                        var content = buildInfowindowContent(mountain, isVisited);
                        infowindow.setContent(content);
                        infowindow.open(map, marker);
                        var btn = document.getElementById('btnStamp');
                        if (btn) {
                            btn.onclick = function() {
                                setStatus('위치 확인 중...');
                                if (!navigator.geolocation) {
                                    setStatus('이 브라우저는 위치를 지원하지 않습니다.');
                                    return;
                                }
                                navigator.geolocation.getCurrentPosition(
                                    function(pos) {
                                        var lat = pos.coords.latitude;
                                        var lon = pos.coords.longitude;
                                        var dist = haversineMeters(lat, lon, getLat(mountain), getLon(mountain));
                                        if (dist > NEAR_RADIUS_M) {
                                            setStatus('정상에서 ' + Math.round(dist) + 'm 떨어져 있습니다. ' + NEAR_RADIUS_M + 'm 이내에서만 찍을 수 있어요.');
                                            return;
                                        }
                                        postFootprint(mountain.id, lat, lon).then(function() {
                                            visitedIds[mountain.id] = true;
                                            refreshFootprintList();
                                            infowindow.setContent(buildInfowindowContent(mountain, true));
                                            setStatus('발자국이 찍혔습니다!');
                                        }).catch(function(err) {
                                            setStatus(err.message || '저장 실패');
                                        });
                                    },
                                    function() { setStatus('위치를 가져올 수 없습니다. GPS/위치 권한을 확인해주세요.'); }
                                );
                            };
                        }
                    });
                })(m);
            }
            if (mountains.length) map.setBounds(bounds);
        }

        function loadMountainsAndMarkers() {
            fetchMountains().then(function(apiMountains) {
                mountains = apiMountains && apiMountains.length ? apiMountains : EMBEDDED_MOUNTAINS;
                return fetchMyFootprints().then(function(footprints) {
                    if (footprints) footprints.forEach(function(f) { visitedIds[f.mountain_id] = true; });
                    addMarkers();
                    refreshFootprintList();
                    setStatus('산을 클릭해 발자국을 찍어보세요. ' + NEAR_RADIUS_M + 'm 이내에서만 가능합니다.');
                });
            }).catch(function() {
                mountains = EMBEDDED_MOUNTAINS;
                fetchMyFootprints().then(function(footprints) {
                    if (footprints) footprints.forEach(function(f) { visitedIds[f.mountain_id] = true; });
                    addMarkers();
                    refreshFootprintList();
                    setStatus('산을 클릭해 발자국을 찍어보세요. ' + NEAR_RADIUS_M + 'm 이내에서만 가능합니다.');
                }).catch(function() {
                    addMarkers();
                    refreshFootprintList();
                    setStatus('산을 클릭해 발자국을 찍어보세요. (오프라인: 발자국 저장은 서버 연결 시 가능)');
                });
            });
        }
        loadMountainsAndMarkers();
    });
})();
</script>
</body>
</html>
